<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poems — Whispers of the Soul</title>

<style>
:root{--maroon:#6E2E2E;--cream:#F4EFE9}
*{box-sizing:border-box}
body{margin:0;font-family:"Times New Roman", serif;background:var(--maroon);color:var(--cream)}

.site-header{
    background:var(--cream);color:var(--maroon);
    padding:22px 28px;display:flex;align-items:center;justify-content:space-between;
    border-bottom:8px solid rgba(0,0,0,0.04);
    position:sticky;top:0;z-index:20
}

.brand{font-size:38px;letter-spacing:2px;font-weight:400}

.nav{display:flex;gap:22px;align-items:center;list-style:none;margin:0;padding:0}
.nav a{color:var(--maroon);text-decoration:none;font-size:16px}

.container{max-width:1100px;margin:26px auto;padding:0 24px 120px}

.banner{
    background:#3e0f0f;height:180px;border-radius:2px;overflow:hidden;margin-bottom:18px;
    display:flex;align-items:center;justify-content:center
}
.banner img{width:100%;height:100%;object-fit:cover}

.title-row{color:var(--cream);margin:20px 0 10px}
.page-title{font-size:40px;font-weight:700;color:var(--cream);margin:0 0 6px}
.meta{color:#f0dcd9;font-size:14px}
.divider-hr{border:none;border-top:1px solid rgba(255,255,255,0.08);margin:18px 0 28px}

.share-wrap{
    border:1px solid rgba(255,255,255,0.06);padding:18px;display:flex;
    gap:16px;align-items:center;margin-bottom:28px
}

.share-input{
    flex:1;padding:14px 16px;background:transparent;border:1px solid rgba(255,255,255,0.06);
    color:var(--cream);border-radius:2px;font-size:16px
}

.send-btn{
    width:140px;background:var(--cream);color:var(--maroon);font-size:20px;padding:12px 18px;
    border:none;cursor:pointer;border-radius:2px;font-family:"Times New Roman", serif
}

.post-card{
    border:1px solid rgba(255,255,255,0.06);padding:22px;margin-bottom:26px;
    background:transparent;position:relative
}

.post-header{display:flex;align-items:center;gap:14px}

.avatar{width:54px;height:54px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,0.06)}
.avatar img{width:100%;height:100%;object-fit:cover}

.post-author{font-size:18px;font-weight:700;color:var(--cream)}
.post-time{font-size:13px;color:#e3cfcf}
.post-title{font-size:22px;margin:14px 0 12px;color:var(--cream)}
.post-body{color:#f0d9d9;line-height:1.8;font-size:16px;white-space:pre-wrap}

.post-actions{display:flex;gap:10px;align-items:center;margin-top:14px}

.like-btn{
    display:flex;gap:10px;align-items:center;cursor:pointer;border:none;background:transparent;
    color:var(--cream);font-size:15px
}

.comment-input{
    margin-top:14px;width:100%;padding:10px 14px;border:1px solid rgba(255,255,255,0.06);
    background:transparent;color:var(--cream);border-radius:2px
}

.comment-btn{
    margin-top:10px;padding:8px 16px;background:var(--cream);color:var(--maroon);
    border:none;cursor:pointer;border-radius:2px;font-family:"Times New Roman", serif
}

.comments-list{margin-top:12px}
.comment-item{margin-top:10px;padding:10px;border-left:3px solid rgba(255,255,255,0.03);color:#f0d9d9}
.comment-author{font-weight:700;color:var(--cream);margin-right:8px}

.site-footer{
    margin-top:44px;background:var(--cream);color:var(--maroon);padding:36px 20px
}

.footer-grid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
    max-width:1100px;margin:0 auto;text-align:center
}
.footer-grid p{font-size:14px;margin:6px 0;line-height:1.6;color:var(--maroon)}

.post-menu{position:absolute;top:20px;right:20px;cursor:pointer;z-index:10}
.dots{font-size:22px;color:var(--cream);line-height:1;padding:5px 10px;user-select:none}

.menu-dropdown{
    display:none;flex-direction:column;position:absolute;top:30px;right:0;background:var(--cream);
    padding:8px;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.15);z-index:50;min-width:120px
}
.menu-dropdown.show{display:flex}
.menu-dropdown button{
    background:transparent;border:none;padding:8px 12px;color:var(--maroon);font-weight:700;
    cursor:pointer;text-align:left;font-size:14px
}
.menu-dropdown button:hover{background:#efe9e6}

@media (max-width:760px){
    .page-title{font-size:28px}
    .banner{height:140px}
    .footer-grid{grid-template-columns:1fr;text-align:left}
}
</style>
</head>

<body>

<header class="site-header">
    <div class="brand">PEN &amp; GAVEL</div>
    <nav class="nav">
        <li><a href="../index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="constitutional-articles.html">Constitutional Articles</a></li>
        <li><a href="past-cases.html">Past Cases</a></li>
        <li><a href="literary.html">Literary Works</a></li>
        <li><a href="legislation.html">Legislation</a></li>
    </nav>
</header>

<main class="container">
    <div class="banner">
        <img src="https://i.ibb.co/sdR1WVjc/poem.jpg" alt="poem banner">
    </div>

    <section class="title-row">
        <h1 class="page-title">Poems — Whispers of the Soul ✦</h1>
        <div class="meta">Public</div>
        <hr class="divider-hr">
    </section>

    <section class="share-wrap">
        <input class="share-input" id="shareText" placeholder="Share something..." />
        <button class="send-btn" id="shareBtn">send</button>
    </section>

    <section id="postsContainer"></section>
</main>

<footer class="site-footer">
    <div class="footer-grid">
        <div>
            <p>7827170170 - NCW Helpline:<br>
            Connects women directly to police, hospitals, One Stop Centres, and legal authorities.</p>
        </div>
        <div>
            <p>1091 - Women Police Helpline:<br>
            Provides immediate police assistance to women in distress.</p>
        </div>
        <div>
            <p>108 - Ambulance Helpline:<br>
            Quick access to emergency medical services.</p>
        </div>
        <div>
            <p>181 - Women Helpline:<br>24x7 emergency response and counselling.</p>
        </div>
        <div>
            <p>112 - National Emergency Number:<br>Single emergency number for all services.</p>
        </div>
        <div>
            <p>Connect with us at:<br><strong>penandgavel.official@gmail.com</strong></p>
        </div>
    </div>
</footer>

<script type="module">

// ============= CRITICAL: LOGIN REDIRECT PATH =============
const LOGIN_PAGE_URL = "../login/index.html";
const CURRENT_PAGE_URL = window.location.href;

const firebaseConfig = {
    apiKey: "AIzaSyC4Yjfr1WqoM-PmEQxHq-Sj2BTQvmoBOkk",
    authDomain: "penandgavelposts.firebaseapp.com",
    databaseURL: "https://penandgavelposts-default-rtdb.firebaseio.com/",
    projectId: "penandgavelposts",
    storageBucket: "penandgavelposts.firebasestorage.app",
    messagingSenderId: "1094706446735",
    appId: "1:1094706446735:web:0d86c105c86ba51ab20bfa"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
    getDatabase, ref, push, onValue, set, get, update, runTransaction, remove
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const postsContainer = document.getElementById("postsContainer");
const shareInput = document.getElementById("shareText");
const shareBtn = document.getElementById("shareBtn");
let currentUser = null;

// ============= AUTH CHECK =============
onAuthStateChanged(auth, (user) => {
    if (!user) {
        localStorage.setItem("redirectAfterLogin", CURRENT_PAGE_URL);
        window.location.href = LOGIN_PAGE_URL;
    } else {
        currentUser = user;
        ensureSamplePost().then(setupRealtimeListeners).catch(err=>console.error(err));
    }
});

async function ensureSamplePost(){
    try{
        const sampleRef = ref(db, "posts/sample_post");
        const snap = await get(sampleRef);
        if (!snap.exists()){
            await set(sampleRef, {
                id: "sample_post",
                title: "Whispers of the Soul",
                body: `Here, poetry blooms like wildflowers – soft, bold, and beautifully free.
Share your verses that capture emotions too deep for conversation,
and let your words dance with rhythm and tenderness.
Each poem is a piece of your soul, and this space celebrates it with love.`,
                authorName: "Pen&Gavel",
                authorAvatar: "https://i.ibb.co/m5xLPmHZ/Corporate-Logo-Designs-Logo-Image-1.jpg",
                createdAt: Date.now(),
                likesCount: 0,
                likedBy: {}
            });
        }
    }catch(e){
        console.error("ensure sample err", e);
    }
}

async function createPost(text){
    if(!currentUser) return alert("You must be logged in to post.");
    if(!text || !text.trim()) return;

    const postsRef = ref(db, "posts");
    const newPostRef = push(postsRef);

    try{
        await set(newPostRef, {
            id: newPostRef.key,
            title: "",
            body: text.trim(),
            authorName: currentUser.displayName || currentUser.email || "Unknown",
            authorAvatar: currentUser.photoURL || "https://i.ibb.co/m5xLPmHZ/Corporate-Logo-Designs-Logo-Image-1.jpg",
            createdAt: Date.now(),
            likesCount: 0,
            likedBy: {}
        });
        shareInput.value = "";
    }catch(err){
        console.error("post create err", err);
        alert("Could not post: "+err.message);
    }
}

async function toggleLike(postId){
    if(!currentUser) return alert("Login to like.");
    const postRef = ref(db, `posts/${postId}`);

    try{
        await runTransaction(postRef, (post) => {
            if (post) {
                post.likedBy = post.likedBy || {};
                const uid = currentUser.uid;

                if (post.likedBy[uid]) {
                    post.likedBy[uid] = null;
                    post.likesCount = (post.likesCount || 0) - 1;
                } else {
                    post.likedBy[uid] = true;
                    post.likesCount = (post.likesCount || 0) + 1;
                }
            }
            return post;
        });
    }catch(err){
        console.error("like err", err);
    }
}

async function addComment(postId, text){
    if(!currentUser) return alert("Login to comment.");
    if(!text || !text.trim()) return;

    try{
        await push(ref(db, `posts/${postId}/comments`), {
            authorName: currentUser.displayName || currentUser.email || "Unknown",
            text: text.trim(),
            createdAt: Date.now()
        });
    }catch(err){
        console.error("comment err", err);
    }
}

async function deletePost(postId){
    if(!currentUser) return alert("Login required.");

    try{
        const postSnap = await get(ref(db, `posts/${postId}`));
        if(!postSnap.exists()) return alert("Post not found");

        const data = postSnap.val();

        if(data.authorName !== (currentUser.displayName || currentUser.email) &&
            currentUser.uid !== data.authorUid){
            return alert("You are not the author.");
        }

        if(!confirm("Delete this post?")) return;
        await remove(ref(db, `posts/${postId}`));
    }catch(err){
        console.error("delete err", err);
    }
}

async function editPost(postId){
    if(!currentUser) return alert("Login required.");
    try{
        const postSnap = await get(ref(db, `posts/${postId}`));
        if(!postSnap.exists()) return alert("Post not found");

        const data = postSnap.val();

        if(data.authorName !== (currentUser.displayName || currentUser.email) &&
            currentUser.uid !== data.authorUid){
            return alert("You are not the author.");
        }

        const newBody = prompt("Edit post content:", data.body||"");
        if(newBody === null) return;

        await update(ref(db, `posts/${postId}`), {
            body: newBody,
            editedAt: Date.now()
        });

    }catch(err){
        console.error("edit err", err);
    }
}

function createPostElement(postObj){
    const container = document.createElement("article");
    container.className = "post-card";
    container.dataset.id = postObj.id;

    const menuWrap = document.createElement("div");
    menuWrap.className = "post-menu";
    
    const dotsSpan = document.createElement("span");
    dotsSpan.className = "dots";
    dotsSpan.textContent = "⋮";
    
    const dropdown = document.createElement("div");
    dropdown.className = "menu-dropdown";
    
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    
    const reportBtn = document.createElement("button");
    reportBtn.textContent = "Report";
    
    dropdown.appendChild(editBtn);
    dropdown.appendChild(deleteBtn);
    dropdown.appendChild(reportBtn);
    menuWrap.appendChild(dotsSpan);
    menuWrap.appendChild(dropdown);

    dotsSpan.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("show");
    });

    document.addEventListener("click", (e) => {
        if (!menuWrap.contains(e.target)) {
            dropdown.classList.remove("show");
        }
    });

    editBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.remove("show");
        editPost(postObj.id);
    });

    deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.remove("show");
        deletePost(postObj.id);
    });

    reportBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.remove("show");
        alert("Post reported. Thank you.");
    });

    const header = document.createElement("div");
    header.className = "post-header";
    header.innerHTML = `
        <div class="avatar">
            <img src="${postObj.authorAvatar || 'https://i.ibb.co/m5xLPmHZ/Corporate-Logo-Designs-Logo-Image-1.jpg'}" alt="avatar">
        </div>
        <div>
            <div class="post-author">${postObj.authorName || 'Unknown'}</div>
            <div class="post-time">${new Date(postObj.createdAt).toLocaleString()}</div>
        </div>
    `;

    const body = document.createElement("div");
    body.className="post-body";
    body.innerText = postObj.body || "";

    const likeBtn = document.createElement("button");
    likeBtn.className="like-btn";
    likeBtn.innerHTML = `❤ <span style="margin-left:8px">${postObj.likesCount || 0}</span>`;
    likeBtn.onclick = ()=> toggleLike(postObj.id);

    const commentInput = document.createElement("input");
    commentInput.className="comment-input";
    commentInput.placeholder="Write a comment...";

    const commentSubmit = document.createElement("button");
    commentSubmit.className="comment-btn";
    commentSubmit.textContent="Comment";
    commentSubmit.onclick = ()=> {
        addComment(postObj.id, commentInput.value);
        commentInput.value="";
    };

    const commentsArea = document.createElement("div");
    commentsArea.className="comments-list";

    container.appendChild(menuWrap);
    container.appendChild(header);
    container.appendChild(body);
    container.appendChild(likeBtn);
    container.appendChild(commentInput);
    container.appendChild(commentSubmit);
    container.appendChild(commentsArea);

    onValue(ref(db, `posts/${postObj.id}/comments`), (snap)=>{
        commentsArea.innerHTML = "";
        const val = snap.val() || {};
        const keys = Object.keys(val).sort((a,b)=>{
            return (val[a].createdAt||0) - (val[b].createdAt||0);
        });

        keys.forEach(k=>{
            const c = val[k];
            const d = document.createElement("div");
            d.className="comment-item";
            d.innerHTML=`<span class="comment-author">${c.authorName || 'Unknown'}</span> ${c.text || ''}`;
            commentsArea.appendChild(d);
        });
    });

    onValue(ref(db, `posts/${postObj.id}`), (snap)=>{
        const d = snap.val();
        if(!d){
            container.remove();
            return;
        }
        likeBtn.innerHTML = `❤ <span style="margin-left:8px">${d.likesCount||0}</span>`;
    });

    return container;
}

function setupRealtimeListeners(){
    onValue(ref(db, "posts"), (snap)=>{
        const posts = snap.val() || {};
        const items = Object.values(posts).sort((a,b)=>
            (b.createdAt||0) - (a.createdAt||0)
        );

        postsContainer.innerHTML = "";
        items.forEach(item=>{
            const el = createPostElement(item);
            postsContainer.appendChild(el);
        });
    });
}

shareBtn.addEventListener("click", ()=> createPost(shareInput.value));
shareInput.addEventListener("keypress", (e)=>{
    if(e.key === "Enter"){
        e.preventDefault();
        createPost(shareInput.value);
    }
});

</script>

<script type="text/javascript">
  (function(d, t) {
      var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
      v.onload = function() {
        window.voiceflow.chat.load({
          verify: { projectID: '69077c8c2c2c409d8b3aa75d' },
          url: 'https://general-runtime.voiceflow.com',
          versionID: 'production',
          voice: {
            url: "https://runtime-api.voiceflow.com"
          }
        });
      }
      v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs"; v.type = "text/javascript"; s.parentNode.insertBefore(v, s);
  })(document, 'script');
</script>

</body>
</html>
